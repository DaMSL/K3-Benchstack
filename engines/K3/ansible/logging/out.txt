create table Globals (
  _mess_id           int,
  _dest_peer         text,
  args               json,
  dataFiles          json,
  elapsed_ms         int,
  end_ms             int,
  load_elapsed_ms    int,
  load_end_ms        int,
  load_start_ms      int,
  local_q1_results   json,
  local_rankings     json,
  master             json,
  me                 json,
  num_results        int,
  outputFile         varchar,
  peers              json,
  peers_finished     int,
  peers_ready        int,
  role               varchar,
  start_ms           int,
  x                  int
);

create table Messages (
  _mess_id           int,
  _dest_peer         text,
  trigger            text,
  source_peer        text,
  contents           text,
  time               text
);


create table Results (
  pageRank           int,
  pageURL            varchar
);


create or replace function load_local_q1_results
(filename text)
returns void as $$
declare jsonVar json;
begin
drop table if exists temp_load_local_q1_results;
create temporary table temp_load_local_q1_results (logEntry json);
execute format('copy temp_load_local_q1_results from ''%s'' ', filename);
select logEntry into jsonVar FROM temp_load_local_q1_results limit 1;
insert into Results select (t#>>'{value,pageRank}')::int,(t#>>'{value,pageURL}')::varchar from json_array_elements(jsonVar->'value') as R(t);
end;
$$ language plpgsql volatile;


select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40000/192.168.0.40:40000_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40001/192.168.0.40:40001_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40002/192.168.0.40:40002_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40003/192.168.0.40:40003_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40004/192.168.0.40:40004_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40005/192.168.0.40:40005_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40006/192.168.0.40:40006_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40007/192.168.0.40:40007_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40008/192.168.0.40:40008_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40009/192.168.0.40:40009_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40010/192.168.0.40:40010_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40011/192.168.0.40:40011_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40012/192.168.0.40:40012_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40013/192.168.0.40:40013_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40014/192.168.0.40:40014_Result.txt');

select
    load_local_q1_results('/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40015/192.168.0.40:40015_Result.txt');




COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40000/192.168.0.40:40000_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40001/192.168.0.40:40001_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40002/192.168.0.40:40002_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40003/192.168.0.40:40003_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40004/192.168.0.40:40004_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40005/192.168.0.40:40005_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40006/192.168.0.40:40006_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40007/192.168.0.40:40007_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40008/192.168.0.40:40008_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40009/192.168.0.40:40009_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40010/192.168.0.40:40010_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40011/192.168.0.40:40011_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40012/192.168.0.40:40012_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40013/192.168.0.40:40013_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40014/192.168.0.40:40014_Globals.dsv' WITH DELIMITER '|';
COPY Globals FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40015/192.168.0.40:40015_Globals.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40000/192.168.0.40:40000_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40001/192.168.0.40:40001_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40002/192.168.0.40:40002_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40003/192.168.0.40:40003_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40004/192.168.0.40:40004_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40005/192.168.0.40:40005_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40006/192.168.0.40:40006_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40007/192.168.0.40:40007_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40008/192.168.0.40:40008_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40009/192.168.0.40:40009_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40010/192.168.0.40:40010_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40011/192.168.0.40:40011_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40012/192.168.0.40:40012_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40013/192.168.0.40:40013_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40014/192.168.0.40:40014_Messages.dsv' WITH DELIMITER '|';
COPY Messages FROM '/tmp/k3_results/k3_amplab_q1_final/192.168.0.40/40015/192.168.0.40:40015_Messages.dsv' WITH DELIMITER '|';
